<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M31è²¡å‹™éƒ¨æœƒè­°è¨˜éŒ„ç³»çµ±</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  :root {
    --ink: #1a1a2e;
    --paper: #f8f5ee;
    --cream: #f0ead6;
    --gold: #c9a84c;
    --gold-light: #e8d5a3;
    --rust: #8b4513;
    --steel: #2c3e50;
    --muted: #7a7267;
    --border: #d4c9a8;
    --success: #2e7d32;
    --danger: #c62828;
    --shadow: 0 4px 24px rgba(26,26,46,0.12);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    line-height: 1.7;
    letter-spacing: 0.02em;
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    font-size: 13px;
  }

  /* â”€â”€ Layout â”€â”€ */
  .app { display: flex; min-height: 100vh; }

  /* â”€â”€ Sidebar Filter â”€â”€ */
  .sidebar-filter {
    padding: 8px 12px 4px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }

  .sidebar-filter-row {
    display: flex;
    gap: 6px;
    margin-bottom: 6px;
    flex-wrap: wrap;
  }

  .sf-btn {
    flex: 1;
    min-width: 0;
    padding: 5px 4px;
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.15);
    background: transparent;
    color: #a0b0c0;
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.18s;
    text-align: center;
    white-space: nowrap;
  }

  .sf-btn:hover { border-color: var(--gold); color: var(--gold); }
  .sf-btn.sf-active { background: var(--gold); color: var(--ink); border-color: var(--gold); }

  .sidebar-search {
    width: 100%;
    background: rgba(255,255,255,0.07);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 4px;
    padding: 6px 10px;
    color: #ddd;
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 12px;
    outline: none;
    margin-bottom: 6px;
    box-sizing: border-box;
  }

  .sidebar-search::placeholder { color: #607080; }
  .sidebar-search:focus { border-color: var(--gold); }

  .history-count {
    font-size: 10px;
    color: #607080;
    padding: 4px 16px 2px;
    letter-spacing: 0.5px;
  }

  .sidebar {
    width: 280px;
    min-width: 280px;
    background: var(--steel);
    color: #e8e8e8;
    display: flex;
    flex-direction: column;
    position: sticky;
    top: 0;
    height: 100vh;
    overflow-y: auto;
  }

  .sidebar-header {
    padding: 28px 20px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    background: linear-gradient(135deg, #1a2a3a, #2c3e50);
  }

  .sidebar-logo {
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 22px;
    font-weight: 700;
    color: var(--gold);
    letter-spacing: 2px;
    line-height: 1.3;
  }

  .sidebar-sub {
    font-size: 11px;
    color: #a0a8b0;
    margin-top: 4px;
    letter-spacing: 1px;
  }

  .sidebar-section {
    padding: 16px 20px 8px;
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--gold);
    text-transform: uppercase;
    font-weight: 700;
  }

  .new-btn {
    margin: 8px 16px 16px;
    padding: 10px 16px;
    background: var(--gold);
    color: var(--ink);
    border: none;
    border-radius: 6px;
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
    width: calc(100% - 32px);
    justify-content: center;
  }

  .new-btn:hover { background: #e8c56a; transform: translateY(-1px); }

  .history-list { flex: 1; overflow-y: auto; }

  .history-item {
    padding: 12px 20px;
    cursor: pointer;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    transition: background 0.15s;
    position: relative;
  }

  .history-item:hover { background: rgba(201,168,76,0.15); }
  .history-item.active { background: rgba(201,168,76,0.2); border-left: 3px solid var(--gold); }

  .history-date {
    font-size: 13px;
    font-weight: 600;
    color: #ddd;
  }

  .history-type {
    font-size: 11px;
    color: #90a0b0;
    margin-top: 2px;
  }

  .history-badge {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 10px;
    background: rgba(201,168,76,0.3);
    color: var(--gold);
    padding: 2px 6px;
    border-radius: 10px;
  }

  .no-history {
    padding: 20px;
    color: #607080;
    font-size: 12px;
    text-align: center;
  }

  /* â”€â”€ Main â”€â”€ */
  .main { flex: 1; padding: 40px 48px; max-width: 960px; }

  /* â”€â”€ Document Header â”€â”€ */
  .doc-header {
    text-align: center;
    border-top: 4px double var(--gold);
    border-bottom: 4px double var(--gold);
    padding: 20px 0;
    margin-bottom: 32px;
    position: relative;
  }

  .doc-title {
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 26px;
    font-weight: 700;
    letter-spacing: 6px;
    color: var(--ink);
  }

  .doc-subtitle {
    font-size: 12px;
    color: var(--muted);
    letter-spacing: 3px;
    margin-top: 4px;
  }

  /* â”€â”€ Form â”€â”€ */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    border: 1px solid var(--border);
    margin-bottom: 24px;
  }

  .form-grid.three { grid-template-columns: 1fr 1fr 1fr; }

  .form-cell {
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: stretch;
  }

  .form-cell:last-child { border-right: none; }
  .form-cell.full { grid-column: 1 / -1; }

  .cell-label {
    background: var(--cream);
    padding: 10px 14px;
    font-size: 13px;
    font-weight: 600;
    color: var(--steel);
    white-space: nowrap;
    min-width: 80px;
    border-right: 1px solid var(--border);
    display: flex;
    align-items: center;
    letter-spacing: 1px;
  }

  .cell-input {
    flex: 1;
    padding: 10px 14px;
  }

  .cell-input input,
  .cell-input select,
  .cell-input textarea {
    width: 100%;
    border: none;
    background: transparent;
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 13px;
    color: var(--ink);
    outline: none;
    resize: none;
  }

  .cell-input select { cursor: pointer; }

  /* â”€â”€ Section Title â”€â”€ */
  .section-title {
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 15px;
    font-weight: 700;
    color: var(--steel);
    border-left: 4px solid var(--gold);
    padding-left: 10px;
    margin: 28px 0 14px;
    letter-spacing: 2px;
  }

  /* â”€â”€ Discussion â”€â”€ */
  .discussion-box {
    border: 1px solid var(--border);
    background: #fff;
    min-height: 120px;
  }

  .discussion-box textarea {
    width: 100%;
    border: none;
    outline: none;
    padding: 14px;
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 13px;
    color: var(--ink);
    background: transparent;
    resize: vertical;
    min-height: 120px;
    line-height: 1.8;
  }

  /* â”€â”€ Follow-up Table â”€â”€ */
  .followup-table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid var(--border);
    font-size: 13px;
  }

  .followup-table th {
    background: var(--cream);
    padding: 10px 12px;
    text-align: center;
    font-weight: 600;
    color: var(--steel);
    border: 1px solid var(--border);
    letter-spacing: 1px;
    font-size: 12px;
  }

  .followup-table td {
    border: 1px solid var(--border);
    padding: 6px 8px;
    vertical-align: middle;
  }

  .followup-table td input,
  .followup-table td select {
    width: 100%;
    border: none;
    outline: none;
    background: transparent;
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 13px;
    color: var(--ink);
    padding: 4px 4px;
  }

  .followup-table td textarea.item-input {
    width: 100%;
    border: none;
    outline: none;
    background: transparent;
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 13px;
    color: var(--ink);
    padding: 4px 4px;
    resize: none;
    overflow: hidden;
    line-height: 1.6;
    min-height: 28px;
    display: block;
  }

  .followup-table td.num {
    text-align: center;
    background: var(--cream);
    font-weight: 700;
    color: var(--gold);
    width: 50px;
    font-size: 12px;
  }

  .followup-table td.status-cell { width: 90px; text-align: center; }

  .status-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .status-pending { background: #fff3cd; color: #856404; border: 1px solid #ffc107; }
  .status-done { background: #d4edda; color: var(--success); border: 1px solid #28a745; }
  .status-overdue { background: #f8d7da; color: var(--danger); border: 1px solid #dc3545; }

  .del-row {
    width: 32px;
    text-align: center;
    cursor: pointer;
    color: #ccc;
    transition: color 0.2s;
  }

  .del-row:hover { color: var(--danger); }

  .add-row-btn {
    margin-top: 10px;
    padding: 8px 16px;
    background: transparent;
    border: 1px dashed var(--border);
    border-radius: 4px;
    color: var(--muted);
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .add-row-btn:hover {
    border-color: var(--gold);
    color: var(--gold);
    background: rgba(201,168,76,0.05);
  }

  /* â”€â”€ Buttons â”€â”€ */
  .btn-bar {
    display: flex;
    gap: 12px;
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
    flex-wrap: wrap;
  }

  .btn {
    padding: 10px 24px;
    border: none;
    border-radius: 4px;
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 1px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .btn-primary { background: var(--gold); color: var(--ink); }
  .btn-primary:hover { background: #e8c56a; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(201,168,76,0.4); }

  .btn-secondary { background: var(--steel); color: #fff; }
  .btn-secondary:hover { background: #1a2a3a; }

  .btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); }
  .btn-danger:hover { background: var(--danger); color: #fff; }

  /* â”€â”€ View Mode â”€â”€ */
  .view-mode .cell-input input,
  .view-mode .cell-input select,
  .view-mode .cell-input textarea,
  .view-mode .discussion-box textarea,
  .view-mode .followup-table td input,
  .view-mode .followup-table td select {
    pointer-events: none;
  }

  .view-mode .add-row-btn { display: none; }
  .view-mode .del-row { display: none; }
  .view-mode .btn-bar { display: none; }

  .view-actions {
    display: flex;
    gap: 12px;
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid var(--border);
  }

  /* â”€â”€ Toast â”€â”€ */
  .toast {
    position: fixed;
    bottom: 32px;
    right: 32px;
    background: var(--steel);
    color: #fff;
    padding: 14px 24px;
    border-radius: 6px;
    font-size: 13px;
    box-shadow: var(--shadow);
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s;
    z-index: 999;
    border-left: 4px solid var(--gold);
  }

  .toast.show { transform: translateY(0); opacity: 1; }

  /* â”€â”€ Filter Panel â”€â”€ */
  .filter-panel {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 20px 24px;
    margin-bottom: 28px;
    display: none;
  }

  .filter-panel.open { display: block; }

  .filter-panel-title {
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 15px;
    font-weight: 700;
    color: var(--steel);
    margin-bottom: 16px;
    letter-spacing: 1px;
  }

  .filter-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }

  .filter-btn {
    padding: 7px 18px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: transparent;
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--muted);
  }

  .filter-btn:hover { border-color: var(--gold); color: var(--gold); }
  .filter-btn.active-all { background: var(--steel); color: #fff; border-color: var(--steel); }
  .filter-btn.active-pending { background: #fff3cd; color: #856404; border-color: #ffc107; }
  .filter-btn.active-done { background: #d4edda; color: var(--success); border-color: #28a745; }
  .filter-btn.active-overdue { background: #f8d7da; color: var(--danger); border-color: #dc3545; }

  .filter-results {
    border: 1px solid var(--border);
    border-radius: 4px;
    overflow: hidden;
  }

  .filter-result-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .filter-result-table th {
    background: var(--cream);
    padding: 9px 12px;
    text-align: left;
    font-weight: 600;
    color: var(--steel);
    border-bottom: 1px solid var(--border);
    font-size: 12px;
    letter-spacing: 1px;
  }

  .filter-result-table td {
    padding: 9px 12px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }

  .filter-result-table tr:last-child td { border-bottom: none; }
  .filter-result-table tr:hover td { background: rgba(201,168,76,0.05); }

  .filter-date-link {
    color: var(--gold);
    cursor: pointer;
    font-weight: 600;
    text-decoration: underline;
    white-space: nowrap;
  }

  .filter-date-link:hover { color: var(--rust); }

  .filter-empty {
    padding: 24px;
    text-align: center;
    color: var(--muted);
    font-size: 13px;
  }

  .filter-count {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 10px;
  }

  .toggle-filter-btn {
    padding: 7px 16px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 4px;
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 12px;
    color: var(--muted);
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .toggle-filter-btn:hover { border-color: var(--gold); color: var(--gold); }
  .toggle-filter-btn.on { background: var(--steel); color: #fff; border-color: var(--steel); }

  /* â”€â”€ Carry-over â”€â”€ */
  .carryover-tag {
    display: inline-block;
    font-size: 10px;
    background: #e8f4fd;
    color: #1565c0;
    border: 1px solid #90caf9;
    border-radius: 3px;
    padding: 1px 5px;
    margin-left: 6px;
    white-space: nowrap;
    vertical-align: middle;
    cursor: pointer;
    font-weight: 600;
  }

  .carryover-tag:hover { background: #bbdefb; }

  .status-continued {
    background: #ede7f6;
    color: #4527a0;
    border: 1px solid #b39ddb;
  }

  /* carry-over modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay.open { display: flex; }

  .modal-box {
    background: var(--paper);
    border-radius: 10px;
    width: 600px;
    max-width: 95vw;
    max-height: 80vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 16px 48px rgba(0,0,0,0.25);
    overflow: hidden;
  }

  .modal-header {
    padding: 20px 24px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--cream);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .modal-title {
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 16px;
    font-weight: 700;
    color: var(--steel);
    letter-spacing: 1px;
  }

  .modal-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--muted);
    line-height: 1;
  }

  .modal-close:hover { color: var(--danger); }

  .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px 24px;
  }

  .modal-section-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--gold);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin: 12px 0 6px;
  }

  .modal-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 9px 12px;
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-bottom: 6px;
    background: #fff;
    cursor: pointer;
    transition: background 0.15s;
  }

  .modal-item:hover { background: rgba(201,168,76,0.08); }
  .modal-item.selected { background: rgba(201,168,76,0.15); border-color: var(--gold); }

  .modal-item input[type=checkbox] { accent-color: var(--gold); width: 15px; height: 15px; flex-shrink: 0; }

  .modal-item-text { flex: 1; font-size: 13px; }
  .modal-item-meta { font-size: 11px; color: var(--muted); }
  .modal-item-source { font-size: 11px; color: #1565c0; margin-top: 2px; }

  .modal-footer {
    padding: 14px 24px;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    background: var(--cream);
  }

  .modal-empty {
    text-align: center;
    color: var(--muted);
    padding: 32px;
    font-size: 13px;
  }

  /* â”€â”€ Email Modal â”€â”€ */
  .email-field {
    margin-bottom: 14px;
  }

  .email-field label {
    display: block;
    font-size: 11px;
    font-weight: 700;
    color: var(--gold);
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin-bottom: 5px;
  }

  .email-field input,
  .email-field textarea {
    width: 100%;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 8px 10px;
    font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;
    font-size: 13px;
    color: var(--ink);
    background: #fff;
    outline: none;
    transition: border-color 0.2s;
  }

  .email-field input:focus,
  .email-field textarea:focus { border-color: var(--gold); }

  .email-field textarea { resize: vertical; min-height: 80px; line-height: 1.6; }

  .contacts-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
  }

  .contact-chip {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 4px 10px;
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 20px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.15s;
    user-select: none;
  }

  .contact-chip:hover { border-color: var(--gold); background: rgba(201,168,76,0.1); }
  .contact-chip.selected { background: var(--gold); color: var(--ink); border-color: var(--gold); font-weight: 600; }

  .contact-chip .chip-name { font-weight: 600; }
  .contact-chip .chip-email { color: var(--muted); font-size: 11px; }
  .contact-chip.selected .chip-email { color: var(--ink); }

  .email-hint {
    font-size: 11px;
    color: var(--muted);
    margin-top: 6px;
    line-height: 1.5;
  }

  .email-hint strong { color: var(--steel); }

  /* â”€â”€ Print â”€â”€ */
  @media print {
    .sidebar, .btn-bar, .view-actions, .add-row-btn, .del-row { display: none !important; }
    .main { padding: 20px; max-width: 100%; }
    body {
    line-height: 1.7;
    letter-spacing: 0.02em; background: #fff; }
  }

  /* â”€â”€ Scrollbar â”€â”€ */
  .history-list::-webkit-scrollbar { width: 4px; }
  .history-list::-webkit-scrollbar-thumb { background: rgba(201,168,76,0.3); border-radius: 2px; }
</style>
</head>
<body>

<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-logo">M31è²¡å‹™éƒ¨</div>
      <div class="sidebar-sub" id="i18n-sidebar-sub">æœƒè­°è¨˜éŒ„ç®¡ç†ç³»çµ±</div>
      <button id="langToggleBtn" onclick="toggleLang()" style="margin-top:8px;background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.25);color:#fff;border-radius:4px;padding:4px 10px;font-size:11px;cursor:pointer;letter-spacing:1px;">EN</button>
    </div>
    <button class="new-btn" onclick="newMeeting()"><span data-i18n="newMeeting">æ–°å¢æœƒè­°è¨˜éŒ„</span></button>
    <div class="sidebar-section" data-i18n="history">æ­·å²è¨˜éŒ„</div>
    <div class="sidebar-filter">
      <input class="sidebar-search" type="text" id="historySearch" placeholder="ğŸ” æœå°‹è¿½è¹¤äº‹é …æˆ–è² è²¬äººâ€¦" oninput="renderHistory()">
      <div class="sidebar-filter-row">
        <button class="sf-btn sf-active" data-hf="all" onclick="setHistoryFilter('all')" data-i18n="all">å…¨éƒ¨</button>
        <button class="sf-btn" data-hf="é€±æœƒ" onclick="setHistoryFilter('é€±æœƒ')" data-i18n="weekly">é€±æœƒ</button>
        <button class="sf-btn" data-hf="æœˆæœƒ" onclick="setHistoryFilter('æœˆæœƒ')" data-i18n="monthly">æœˆæœƒ</button>
      </div>
      <div class="sidebar-filter-row">
        <button class="sf-btn" data-hf="å°ˆæ¡ˆ" onclick="setHistoryFilter('å°ˆæ¡ˆ')" data-i18n="project">å°ˆæ¡ˆ</button>
        <button class="sf-btn" data-hf="KPI" onclick="setHistoryFilter('KPI')">KPI</button>
        <button class="sf-btn" data-hf="ç³»çµ±" onclick="setHistoryFilter('ç³»çµ±')" data-i18n="system">ç³»çµ±</button>
        <button class="sf-btn" data-hf="å…¶ä»–" onclick="setHistoryFilter('å…¶ä»–')" data-i18n="other">å…¶ä»–</button>
      </div>
    </div>
    <div class="history-count" id="historyCount"></div>
    <div class="history-list" id="historyList">
      <div class="no-history">å°šç„¡æ­·å²è¨˜éŒ„</div>
    </div>
  </aside>

  <!-- Main -->
  <main class="main" id="mainContent">
    <div id="formArea">
      <!-- Doc Header -->
      <div class="doc-header">
        <div class="doc-title">M31è²¡å‹™éƒ¨æœƒè­°è¨˜éŒ„</div>
        <div id="i18n-doc-title" style="display:none;font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;font-size:22px;font-weight:700;letter-spacing:4px;color:var(--steel)">M31 Finance Dept. Meeting Minutes</div>
        <div class="doc-subtitle" id="i18n-doc-subtitle">MEETING MINUTES Â· FINANCE DEPARTMENT</div>
      </div>

      <!-- Basic Info -->
      <div class="form-grid">
        <div class="form-cell">
          <div class="cell-label" data-i18n="meetingType">æœƒè­°ä¸»é¡Œ</div>
          <div class="cell-input">
            <select id="meetingType">
              <option value="">è«‹é¸æ“‡â€¦</option>
              <option value="éƒ¨é–€é€±æœƒ" data-i18n-val="weekly">éƒ¨é–€é€±æœƒ</option>
              <option value="éƒ¨é–€æœˆæœƒ" data-i18n-val="monthly">éƒ¨é–€æœˆæœƒ</option>
              <option value="å°ˆæ¡ˆ" data-i18n-val="project">å°ˆæ¡ˆ</option>
              <option value="KPI">KPI</option>
              <option value="ç³»çµ±" data-i18n-val="system">ç³»çµ±</option>
              <option value="å…¶ä»–" data-i18n-val="other">å…¶ä»–</option>
            </select>
          </div>
        </div>
        <div class="form-cell">
          <div class="cell-label" data-i18n="meetingDate">æœƒè­°æ—¥æœŸ</div>
          <div class="cell-input">
            <input type="date" id="meetingDate">
          </div>
        </div>
        <div class="form-cell">
          <div class="cell-label" data-i18n="startTime">é–‹å§‹æ™‚é–“</div>
          <div class="cell-input">
            <select id="meetingStartTime" onchange="updateEndTime()"></select>
          </div>
        </div>
        <div class="form-cell">
          <div class="cell-label" data-i18n="duration">æœƒè­°é•·åº¦</div>
          <div class="cell-input">
            <select id="meetingDuration" onchange="updateEndTime()">
              <option value="30" data-i18n="d30">30 åˆ†é˜</option>
              <option value="60" selected data-i18n="d60">1 å°æ™‚</option>
              <option value="90" data-i18n="d90">1.5 å°æ™‚</option>
              <option value="120" data-i18n="d120">2 å°æ™‚</option>
              <option value="150" data-i18n="d150">2.5 å°æ™‚</option>
              <option value="180" data-i18n="d180">3 å°æ™‚</option>
            </select>
          </div>
        </div>
        <div class="form-cell full">
          <div class="cell-label" data-i18n="meetingTime">æœƒè­°æ™‚é–“</div>
          <div class="cell-input">
            <input type="text" id="meetingTime" readonly style="color:var(--muted); background:transparent;">
          </div>
        </div>
        <div class="form-cell full">
          <div class="cell-label" data-i18n="recorder">è¨˜éŒ„äºº</div>
          <div class="cell-input">
            <input type="text" id="recorder">
          </div>
        </div>
      </div>

      <!-- Filter Panel -->
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
        <div class="section-title" style="margin:0" data-i18n="followupFilter">è¿½è¹¤äº‹é …ç¯©é¸</div>
        <button class="toggle-filter-btn" id="toggleFilterBtn" onclick="toggleFilter()" data-i18n="crossFilter">ğŸ” è·¨æœƒè­°ç¯©é¸</button>
      </div>
      <div class="filter-panel" id="filterPanel">
        <div class="filter-controls">
          <span style="font-size: 12px; color:var(--muted); margin-right:4px;"><span data-i18n="filterStatus">ç¯©é¸ç‹€æ…‹ï¼š</span>
          <button class="filter-btn active-all" data-status="all" onclick="applyFilter('all')" data-i18n="all">å…¨éƒ¨</button>
          <button class="filter-btn" data-status="pending" onclick="applyFilter('pending')" data-i18n="inProgress">é€²è¡Œä¸­</button>
          <button class="filter-btn" data-status="done" onclick="applyFilter('done')" data-i18n="done">å·²å®Œæˆ</button>
          <button class="filter-btn" data-status="overdue" onclick="applyFilter('overdue')" data-i18n="overdue">é€¾æœŸ</button>
        </div>
        <div class="filter-count" id="filterCount"></div>
        <div class="filter-results" id="filterResults"></div>
      </div>

      <!-- Discussion -->
      <div class="section-title" data-i18n="discussion">æœƒè­°è¨è«–å…§å®¹</div>
      <div class="discussion-box">
        <textarea id="discussion" placeholder="è«‹è¼¸å…¥æœ¬æ¬¡æœƒè­°è¨è«–äº‹é …ã€æ±ºè­°ã€å‚™è¨»â€¦" rows="6"></textarea>
      </div>

      <!-- Follow-up -->
      <div class="section-title" data-i18n="followupItems">è¿½è¹¤äº‹é …</div>
      <table class="followup-table" id="followupTable">
        <thead>
          <tr>
            <th style="width:55px" data-i18n="no">ç·¨è™Ÿ</th>
            <th data-i18n="followupItem">è¿½è¹¤äº‹é …</th>
            <th style="width:120px" data-i18n="owner">è² è²¬äºº</th>
            <th style="width:130px" data-i18n="deadline">å®Œæˆæ—¥</th>
            <th style="width:90px" data-i18n="status">ç‹€æ…‹</th>
            <th style="width:90px" data-i18n="source">ä¾†æº</th>
            <th style="width:36px"></th>
          </tr>
        </thead>
        <tbody id="followupBody"></tbody>
      </table>
      <button class="add-row-btn" onclick="addRow()"><span data-i18n="addItem">æ–°å¢è¿½è¹¤äº‹é …</span></button>

      <!-- Buttons -->
      <div class="btn-bar">
        <button class="btn btn-primary" onclick="saveMeeting()" data-i18n="save">ğŸ’¾ å„²å­˜è¨˜éŒ„</button>
        <button class="btn btn-secondary" onclick="openCarryoverModal()" data-i18n="carryover">â†© å»¶çºŒè¿½è¹¤</button>
        <button class="btn btn-secondary" onclick="openEmailModal()" data-i18n="sendEmail">ğŸ“§ å¯„é€è¨˜éŒ„</button>
        <button class="btn btn-secondary" onclick="printPage()" data-i18n="print">ğŸ–¨ åˆ—å°</button>
        <button class="btn btn-danger" id="deleteBtn" style="display:none" onclick="deleteCurrentMeeting()" data-i18n="delete">ğŸ—‘ åˆªé™¤æ­¤è¨˜éŒ„</button>
      </div>
    </div>
  </main>
</div>

<!-- Email Modal -->
<div class="modal-overlay" id="emailModal">
  <div class="modal-box" style="width:560px">
    <div class="modal-header">
      <div class="modal-title" data-i18n="emailModalTitle">ğŸ“§ å¯„é€æœƒè­°è¨˜éŒ„</div>
      <button class="modal-close" onclick="closeEmailModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="email-field">
        <label data-i18n="contacts">å›ºå®šè¯çµ¡äººï¼ˆé»é¸åŠ å…¥æ”¶ä»¶äººï¼‰</label>
        <div class="contacts-list" id="contactChips"></div>
      </div>
      <div class="email-field">
        <label>æ”¶ä»¶äºº Email</label>
        <input type="text" id="emailTo" placeholder="å¤šä½æ”¶ä»¶äººä»¥åˆ†è™Ÿ ; åˆ†éš”">
      </div>
      <div class="email-field">
        <label data-i18n="cc">å‰¯æœ¬ CC</label>
        <input type="text" id="emailCc" placeholder="é¸å¡«ï¼Œå¤šä½ä»¥åˆ†è™Ÿ ; åˆ†éš”">
      </div>
      <div class="email-field">
        <label data-i18n="subject">ä¸»æ—¨</label>
        <input type="text" id="emailSubject">
      </div>
      <div class="email-field">
        <label data-i18n="emailBody">ä¿¡ä»¶å…§æ–‡</label>
        <textarea id="emailBody" rows="5"></textarea>
      </div>
      <div class="email-hint">
        ğŸ’¡ é»æ“Šã€Œå¯„é€ã€å¾Œç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿ PDF ä¸¦é€éæœ¬æ©Ÿä¼ºæœå™¨å¯„å‡ºã€‚è«‹å…ˆåœ¨çµ‚ç«¯æ©ŸåŸ·è¡Œ <strong>node server.js</strong>ã€‚
      </div>
    </div>
    <div class="modal-footer">
      <div style="margin-right:auto">
        <button class="btn btn-secondary" onclick="manageContacts()" style="font-size:11px; padding:6px 12px" data-i18n="manageContacts">âš™ï¸ ç®¡ç†è¯çµ¡äºº</button>
      </div>
      <button class="btn btn-secondary" onclick="closeEmailModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="sendEmail()" data-i18n="sendBtn">ğŸ“§ å¯„é€</button>
    </div>
  </div>
</div>

<!-- Contacts Manager Modal -->
<div class="modal-overlay" id="contactsModal">
  <div class="modal-box" style="width:460px">
    <div class="modal-header">
      <div class="modal-title" data-i18n="manageContactsTitle">âš™ï¸ ç®¡ç†å›ºå®šè¯çµ¡äºº</div>
      <button class="modal-close" onclick="closeContactsModal()">Ã—</button>
    </div>
    <div class="modal-body" id="contactsManagerBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeContactsModal()" data-i18n="close">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- Carry-over Modal -->
<div class="modal-overlay" id="carryoverModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" data-i18n="carryoverTitle">â†© å»¶çºŒè¿½è¹¤äº‹é …</div>
      <button class="modal-close" onclick="closeCarryoverModal()">Ã—</button>
    </div>
    <div class="modal-body" id="carryoverModalBody"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeCarryoverModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="confirmCarryover()" data-i18n="confirmCarryover">å¸¶å…¥é¸å–äº‹é …</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â”€â”€ State â”€â”€
let meetings = JSON.parse(localStorage.getItem('m31_meetings') || '[]');
let currentId = null;
let isNew = true;
let rowCount = 0;

// â”€â”€ Init â”€â”€
window.onload = () => {
  document.getElementById('meetingDate').value = today();
  buildTimeOptions();
  updateEndTime();
  renderHistory();
  addRow();
};

function buildTimeOptions() {
  const sel = document.getElementById('meetingStartTime');
  for (let h = 0; h < 24; h++) {
    for (let m = 0; m < 60; m += 30) {
      const val = h * 60 + m;
      const label = String(h).padStart(2,'0') + ':' + String(m).padStart(2,'0');
      const opt = document.createElement('option');
      opt.value = val;
      opt.textContent = label;
      if (val === 9 * 60) opt.selected = true;
      sel.appendChild(opt);
    }
  }
}

function updateEndTime() {
  const startMin = parseInt(document.getElementById('meetingStartTime').value);
  const duration = parseInt(document.getElementById('meetingDuration').value);
  const endMin = (startMin + duration) % (24 * 60);
  const fmt = m => String(Math.floor(m/60)).padStart(2,'0') + ':' + String(m%60).padStart(2,'0');
  document.getElementById('meetingTime').value = fmt(startMin) + ' â€“ ' + fmt(endMin);
}

function today() {
  return new Date().toISOString().split('T')[0];
}

// â”€â”€ History â”€â”€
let historyFilter = 'all';

function setHistoryFilter(val) {
  historyFilter = val;
  document.querySelectorAll('.sf-btn').forEach(b => {
    b.classList.toggle('sf-active', b.dataset.hf === val);
  });
  renderHistory();
}

function renderHistory() {
  const list = document.getElementById('historyList');
  const countEl = document.getElementById('historyCount');
  const keyword = (document.getElementById('historySearch')?.value || '').trim().toLowerCase();

  if (!meetings.length) {
    list.innerHTML = `<div class="no-history">${t('noHistory')}<br><small>${t('noHistorySmall')}</small></div>`;
    countEl.textContent = '';
    return;
  }

  let filtered = [...meetings].sort((a, b) => b.date.localeCompare(a.date));

  // Type filter
  if (historyFilter !== 'all') {
    filtered = filtered.filter(m => (m.type || '').includes(historyFilter));
  }

  // Keyword search â€” from followup items
  if (keyword) {
    filtered = filtered.filter(m =>
      (m.followups || []).some(f =>
        (f.item || '').toLowerCase().includes(keyword) ||
        (f.owner || '').toLowerCase().includes(keyword)
      )
    );
  }

  countEl.textContent = currentLang === 'en'
    ? filtered.length + ' record(s)'
    : 'å…± ' + filtered.length + ' ç­†';

  if (!filtered.length) {
    list.innerHTML = '<div class="no-history">' + t('noMatch') + '</div>';
    return;
  }

  var typeDisplayMap = {
    'éƒ¨é–€é€±æœƒ': t('typeWeekly'), 'éƒ¨é–€æœˆæœƒ': t('typeMonthly'),
    'å°ˆæ¡ˆ': t('project'), 'KPI': 'KPI', 'ç³»çµ±': t('system'), 'å…¶ä»–': t('other')
  };

  list.innerHTML = filtered.map(function(m) {
    return '<div class="history-item ' + (m.id === currentId ? 'active' : '') + '" onclick="loadMeeting(\'' + m.id + '\')">' +
      '<div class="history-date">' + m.date + '</div>' +
      '<div class="history-type">' + (typeDisplayMap[m.type] || m.type || 'â€”') + '</div>' +
      '<div class="history-badge">' + countPending(m) + '</div>' +
    '</div>';
  }).join('');
}

function countPending(m) {
  const pending = (m.followups || []).filter(f => f.status !== 'done').length;
  return pending ? `${pending} ${t('pending')}` : 'âœ“';
}

// â”€â”€ New Meeting â”€â”€
function newMeeting() {
  currentId = null;
  isNew = true;
  document.getElementById('meetingType').value = '';
  document.getElementById('meetingDate').value = today();
  document.getElementById('meetingStartTime').value = 540;
  document.getElementById('meetingDuration').value = 60;
  updateEndTime();
  document.getElementById('recorder').value = '';
  document.getElementById('discussion').value = '';
  document.getElementById('deleteBtn').style.display = 'none';
  rowCount = 0;
  document.getElementById('followupBody').innerHTML = '';
  addRow();
  renderHistory();
  if (filterOpen) applyFilter(currentFilter);
  enableEdit();
}

// â”€â”€ Add Row â”€â”€
function addRow(carryFrom) {
  rowCount++;
  const num = String(rowCount).padStart(3, '0');
  const tr = document.createElement('tr');
  tr.id = `row_${rowCount}`;
  const sourceHtml = carryFrom
    ? `<td style="text-align:center"><span class="carryover-tag" title="ä¾†è‡ª ${carryFrom.date}" onclick="loadMeeting('${carryFrom.id}')">â†© ${carryFrom.date}</span></td>`
    : `<td style="text-align:center; color:#ccc; font-size:11px">â€”</td>`;
  tr.innerHTML = `
    <td class="num">${num}</td>
    <td><textarea class="item-input" placeholder="æè¿°è¿½è¹¤äº‹é …â€¦" oninput="autoResize(this)" rows="1"></textarea></td>
    <td><input type="text" placeholder="å§“å"></td>
    <td><input type="date"></td>
    <td class="status-cell">
      <span class="status-badge status-pending" onclick="toggleStatus(this)">${t('inProgress')}</span>
    </td>
    ${sourceHtml}
    <td class="del-row" onclick="this.closest('tr').remove()">âœ•</td>
  `;
  document.getElementById('followupBody').appendChild(tr);
}

function toggleStatus(el) {
  if (el.classList.contains('status-pending')) {
    el.className = 'status-badge status-done';
    el.textContent = t('done');
  } else if (el.classList.contains('status-done')) {
    el.className = 'status-badge status-overdue';
    el.textContent = t('overdue');
  } else if (el.classList.contains('status-overdue')) {
    el.className = 'status-badge status-continued';
    el.textContent = t('continued');
  } else {
    el.className = 'status-badge status-pending';
    el.textContent = t('inProgress');
  }
}

// â”€â”€ Auto-resize textarea â”€â”€
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = el.scrollHeight + 'px';
}

function autoResizeAll() {
  document.querySelectorAll('textarea.item-input').forEach(autoResize);
}

// â”€â”€ Save â”€â”€
function saveMeeting() {
  const date = document.getElementById('meetingDate').value;
  const type = document.getElementById('meetingType').value;
  if (!date) { showToast(t('validDate')); return; }
  if (!type) { showToast(t('validType')); return; }

  const followups = [];
  document.querySelectorAll('#followupBody tr').forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    const item = cells[1]?.querySelector('textarea')?.value || '';
    if (!item.trim()) return;
    const statusEl = cells[4]?.querySelector('.status-badge');
    let status = 'pending';
    if (statusEl?.classList.contains('status-done')) status = 'done';
    else if (statusEl?.classList.contains('status-overdue')) status = 'overdue';
    else if (statusEl?.classList.contains('status-continued')) status = 'continued';
    // read carryFrom from tag if present
    const tag = cells[5]?.querySelector('.carryover-tag');
    let carryFrom = null;
    if (tag) {
      const onclickStr = tag.getAttribute('onclick') || '';
      const idMatch = onclickStr.match(/loadMeeting\('([^']+)'\)/);
      if (idMatch) {
        const srcMeeting = meetings.find(m => m.id === idMatch[1]);
        if (srcMeeting) carryFrom = { id: srcMeeting.id, date: srcMeeting.date };
      }
    }
    followups.push({
      num: String(i + 1).padStart(3, '0'),
      item,
      owner: cells[2]?.querySelector('input')?.value || '',
      deadline: cells[3]?.querySelector('input')?.value || '',
      status,
      carryFrom
    });
  });

  const data = {
    id: currentId || Date.now().toString(),
    date,
    type,
    startHour: document.getElementById('meetingStartTime').value,
    duration: document.getElementById('meetingDuration').value,
    time: document.getElementById('meetingTime').value,
    recorder: document.getElementById('recorder').value,
    discussion: document.getElementById('discussion').value,
    followups
  };

  if (currentId) {
    const idx = meetings.findIndex(m => m.id === currentId);
    if (idx >= 0) meetings[idx] = data;
  } else {
    meetings.push(data);
    currentId = data.id;
  }

  localStorage.setItem('m31_meetings', JSON.stringify(meetings));
  isNew = false;
  document.getElementById('deleteBtn').style.display = '';
  renderHistory();
  if (filterOpen) applyFilter(currentFilter);
  showToast(t('toastSaved'));
}

// â”€â”€ Load â”€â”€
function loadMeeting(id) {
  const m = meetings.find(x => x.id === id);
  if (!m) return;
  currentId = id;
  isNew = false;

  document.getElementById('meetingType').value = m.type || '';
  document.getElementById('meetingDate').value = m.date || '';
  if (m.startHour !== undefined) {
    document.getElementById('meetingStartTime').value = m.startHour;
    if (m.duration) document.getElementById('meetingDuration').value = m.duration;
    updateEndTime();
  } else {
    document.getElementById('meetingTime').value = m.time || '';
  }
  document.getElementById('recorder').value = m.recorder || '';
  document.getElementById('discussion').value = m.discussion || '';
  document.getElementById('deleteBtn').style.display = '';

  // Followups
  rowCount = 0;
  document.getElementById('followupBody').innerHTML = '';
  (m.followups || []).forEach(f => {
    rowCount++;
    const tr = document.createElement('tr');
    tr.id = `row_${rowCount}`;
    let cls = 'status-pending', label = t('inProgress');
    if (f.status === 'done') { cls = 'status-done'; label = t('done'); }
    else if (f.status === 'overdue') { cls = 'status-overdue'; label = t('overdue'); }
    else if (f.status === 'continued') { cls = 'status-continued'; label = t('continued'); }
    const sourceHtml = f.carryFrom
      ? `<td style="text-align:center"><span class="carryover-tag" title="ä¾†è‡ª ${f.carryFrom.date}" onclick="loadMeeting('${f.carryFrom.id}')">â†© ${f.carryFrom.date}</span></td>`
      : `<td style="text-align:center; color:#ccc; font-size:11px">â€”</td>`;
    tr.innerHTML = `
      <td class="num">${f.num}</td>
      <td><textarea class="item-input" oninput="autoResize(this)" rows="1">${f.item || ''}</textarea></td>
      <td><input type="text" value="${f.owner || ''}"></td>
      <td><input type="date" value="${f.deadline || ''}"></td>
      <td class="status-cell"><span class="status-badge ${cls}" onclick="toggleStatus(this)">${label}</span></td>
      ${sourceHtml}
      <td class="del-row" onclick="this.closest('tr').remove()">âœ•</td>
    `;
    document.getElementById('followupBody').appendChild(tr);
  });

  enableEdit();
  renderHistory();
  setTimeout(autoResizeAll, 0);
}

// â”€â”€ Delete â”€â”€
function deleteCurrentMeeting() {
  if (!currentId) return;
  if (!confirm(t('confirmDelete'))) return;
  meetings = meetings.filter(m => m.id !== currentId);
  localStorage.setItem('m31_meetings', JSON.stringify(meetings));
  newMeeting();
  showToast(t('toastDeleted'));
}

// â”€â”€ Carry-over â”€â”€
function openCarryoverModal() {
  // Collect all pending/overdue items from OTHER meetings
  const body = document.getElementById('carryoverModalBody');
  const otherMeetings = [...meetings]
    .filter(m => m.id !== currentId)
    .sort((a, b) => b.date.localeCompare(a.date));

  // Also collect from current meeting's existing carryFrom sources to avoid re-importing
  const alreadyCarried = new Set();
  document.querySelectorAll('#followupBody .carryover-tag').forEach(tag => {
    const m = tag.getAttribute('onclick').match(/loadMeeting\('([^']+)'\)/);
    if (m) alreadyCarried.add(m[1] + '_' + tag.closest('tr').querySelector('input').value);
  });

  let html = '';
  let totalItems = 0;

  otherMeetings.forEach(m => {
    const pending = (m.followups || []).filter(f => f.status !== 'done' && f.status !== 'continued');
    if (!pending.length) return;
    html += `<div class="modal-section-label">${m.date}ãƒ»${m.type || 'â€”'}</div>`;
    pending.forEach(f => {
      const key = m.id + '_' + f.item;
      const alreadyIn = alreadyCarried.has(key);
      html += `
        <label class="modal-item ${alreadyIn ? 'selected' : ''}" onclick="toggleModalItem(this)">
          <input type="checkbox" ${alreadyIn ? 'checked' : ''} data-src-id="${m.id}" data-src-date="${m.date}" data-item="${(f.item||'').replace(/"/g,'&quot;')}" data-owner="${(f.owner||'').replace(/"/g,'&quot;')}" data-deadline="${f.deadline||''}">
          <div class="modal-item-text">
            <div>${f.item || 'â€”'}</div>
            <div class="modal-item-meta">${t('carryoverOwner')}${f.owner || 'â€”'}ã€€${t('carryoverDeadline')}${f.deadline || 'â€”'}</div>
          </div>
        </label>`;
      totalItems++;
    });
  });

  if (!totalItems) {
    html = `<div class="modal-empty">${t('noCarryover')}</div>`;
  }

  body.innerHTML = html;
  document.getElementById('carryoverModal').classList.add('open');
}

function toggleModalItem(label) {
  const cb = label.querySelector('input[type=checkbox]');
  cb.checked = !cb.checked;
  label.classList.toggle('selected', cb.checked);
}

function closeCarryoverModal() {
  document.getElementById('carryoverModal').classList.remove('open');
}

function confirmCarryover() {
  const checked = document.querySelectorAll('#carryoverModalBody input[type=checkbox]:checked');
  if (!checked.length) { closeCarryoverModal(); return; }

  // Remove the default empty row if only one blank row exists
  const tbody = document.getElementById('followupBody');
  const rows = tbody.querySelectorAll('tr');
  if (rows.length === 1) {
    const firstInput = rows[0].querySelector('input[type=text]');
    if (!firstInput?.value.trim()) tbody.innerHTML = '';
  }

  checked.forEach(cb => {
    const carryFrom = { id: cb.dataset.srcId, date: cb.dataset.srcDate };
    rowCount++;
    const num = String(rowCount).padStart(3, '0');
    const tr = document.createElement('tr');
    tr.id = `row_${rowCount}`;
    tr.innerHTML = `
      <td class="num">${num}</td>
      <td><textarea class="item-input" oninput="autoResize(this)" rows="1">${cb.dataset.item || ''}</textarea></td>
      <td><input type="text" value="${cb.dataset.owner || ''}"></td>
      <td><input type="date" value="${cb.dataset.deadline || ''}"></td>
      <td class="status-cell"><span class="status-badge status-pending" onclick="toggleStatus(this)">${t('inProgress')}</span></td>
      <td style="text-align:center"><span class="carryover-tag" title="ä¾†è‡ª ${carryFrom.date}" onclick="loadMeeting('${carryFrom.id}')">â†© ${carryFrom.date}</span></td>
      <td class="del-row" onclick="this.closest('tr').remove()">âœ•</td>
    `;
    tbody.appendChild(tr);

    // Mark source item as continued
    const srcMeeting = meetings.find(m => m.id === cb.dataset.srcId);
    if (srcMeeting) {
      const srcItem = (srcMeeting.followups || []).find(f => f.item === cb.dataset.item);
      if (srcItem) srcItem.status = 'continued';
    }
  });

  localStorage.setItem('m31_meetings', JSON.stringify(meetings));
  closeCarryoverModal();
  showToast(t('toastCarryover', checked.length));
}

// â”€â”€ Filter â”€â”€
let filterOpen = false;
let currentFilter = 'all';

function toggleFilter() {
  filterOpen = !filterOpen;
  const panel = document.getElementById('filterPanel');
  const btn = document.getElementById('toggleFilterBtn');
  panel.classList.toggle('open', filterOpen);
  btn.classList.toggle('on', filterOpen);
  btn.textContent = filterOpen ? t('closeCrossFilter') : t('crossFilter');
  if (filterOpen) applyFilter(currentFilter);
}

function applyFilter(status) {
  currentFilter = status;

  // Update button states
  document.querySelectorAll('.filter-btn').forEach(b => {
    b.className = 'filter-btn';
    if (b.dataset.status === status) {
      const map = { all: 'active-all', pending: 'active-pending', done: 'active-done', overdue: 'active-overdue' };
      b.classList.add(map[status]);
    }
  });

  // Collect matching items across all meetings
  const results = [];
  meetings.forEach(m => {
    (m.followups || []).forEach(f => {
      if (status === 'all' || f.status === status) {
        results.push({ ...f, meetingDate: m.date, meetingType: m.type || 'â€”', meetingId: m.id });
      }
    });
  });

  // Sort by deadline (empty last), then by date
  results.sort((a, b) => {
    if (a.deadline && b.deadline) return a.deadline.localeCompare(b.deadline);
    if (a.deadline) return -1;
    if (b.deadline) return 1;
    return b.meetingDate.localeCompare(a.meetingDate);
  });

  const count = document.getElementById('filterCount');
  const container = document.getElementById('filterResults');

  const statusLabel = t('filterLabels');
  count.textContent = t('filterCount', results.length, statusLabel[status] || status);

  if (!results.length) {
    container.innerHTML = `<div class="filter-empty">${t('filterEmpty')}</div>`;
    return;
  }

  const statusMap = {
    pending: ['status-pending', t('inProgress')],
    done:    ['status-done',    t('done')],
    overdue: ['status-overdue', t('overdue')]
  };

  const typeDisplayMap = {
    'éƒ¨é–€é€±æœƒ': t('typeWeekly'), 'éƒ¨é–€æœˆæœƒ': t('typeMonthly'),
    'å°ˆæ¡ˆ': t('project'), 'KPI': 'KPI', 'ç³»çµ±': t('system'), 'å…¶ä»–': t('other')
  };

  container.innerHTML = `
    <table class="filter-result-table">
      <thead>
        <tr>
          <th style="width:110px">${t('filterMeetingDate')}</th>
          <th style="width:90px">${t('filterMeetingType')}</th>
          <th>${t('filterItem')}</th>
          <th style="width:90px">${t('filterOwner')}</th>
          <th style="width:100px">${t('filterDeadline')}</th>
          <th style="width:80px">${t('filterStatusCol')}</th>
        </tr>
      </thead>
      <tbody>
        ${results.map(r => {
          const [cls, lbl] = statusMap[r.status] || ['status-pending', t('inProgress')];
          const typeLabel = typeDisplayMap[r.meetingType] || r.meetingType;
          return `<tr>
            <td><span class="filter-date-link" onclick="loadMeeting('${r.meetingId}')">${r.meetingDate}</span></td>
            <td style="font-size: 12px; color:var(--muted)">${typeLabel}</td>
            <td>${r.item || 'â€”'}</td>
            <td>${r.owner || 'â€”'}</td>
            <td style="font-size:12px">${r.deadline || 'â€”'}</td>
            <td><span class="status-badge ${cls}" style="cursor:default">${lbl}</span></td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>
  `;
}

// â”€â”€ Edit Mode â”€â”€
function enableEdit() {
  document.getElementById('formArea').classList.remove('view-mode');
}

// â”€â”€ Print â”€â”€
function printPage() {
  window.print();
}

// â”€â”€ Email & PDF â”€â”€
let contacts = JSON.parse(localStorage.getItem('m31_contacts') || '[]');

function openEmailModal() {
  const m = meetings.find(x => x.id === currentId);
  const date = document.getElementById('meetingDate').value || '';
  const type = document.getElementById('meetingType').value || '';
  const time = document.getElementById('meetingTime').value || '';

  // Pre-fill subject
  document.getElementById('emailSubject').value = t('emailSubjectTemplate', type, date);

  // Pre-fill body
  const followupLines = [];
  document.querySelectorAll('#followupBody tr').forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    const item = cells[1]?.querySelector('textarea')?.value || '';
    if (!item.trim()) return;
    const owner = cells[2]?.querySelector('input')?.value || 'â€”';
    const deadline = cells[3]?.querySelector('input')?.value || 'â€”';
    const statusEl = cells[4]?.querySelector('.status-badge');
    const status = statusEl?.textContent || 'â€”';
    followupLines.push(t('emailFollowupLine', String(i+1).padStart(2,'0'), item, owner, deadline, status));
  });

  const body = t('emailBodyTemplate', date, type, time, followupLines, document.getElementById('recorder').value || 'â€”');

  document.getElementById('emailBody').value = body;

  // Render contact chips
  renderContactChips();
  document.getElementById('emailModal').classList.add('open');
}

function renderContactChips() {
  const container = document.getElementById('contactChips');
  if (!contacts.length) {
    container.innerHTML = `<span style="font-size:12px; color:var(--muted)">${t('noContacts')}</span>`;
    return;
  }
  container.innerHTML = contacts.map((c, i) => `
    <div class="contact-chip" id="chip_${i}" onclick="toggleChip(${i})">
      <span class="chip-name">${c.name}</span>
      <span class="chip-email">&lt;${c.email}&gt;</span>
    </div>
  `).join('');
}

function toggleChip(i) {
  const chip = document.getElementById(`chip_${i}`);
  chip.classList.toggle('selected');
  // Sync to emailTo field
  const selected = contacts.filter((_, idx) => document.getElementById(`chip_${idx}`)?.classList.contains('selected'));
  const existing = document.getElementById('emailTo').value.trim();
  // Rebuild: keep manually typed ones (not matching any contact email), then add selected
  const contactEmails = contacts.map(c => c.email.toLowerCase());
  const manual = existing ? existing.split(';').map(e => e.trim()).filter(e => e && !contactEmails.includes(e.toLowerCase())) : [];
  const all = [...manual, ...selected.map(c => c.email)];
  document.getElementById('emailTo').value = all.join('; ');
}

function closeEmailModal() {
  document.getElementById('emailModal').classList.remove('open');
}

// â”€â”€ Email & PDF â”€â”€
function sendEmail() {
  const to = document.getElementById('emailTo').value.trim();
  const cc = document.getElementById('emailCc').value.trim();
  const subject = document.getElementById('emailSubject').value.trim();
  const body = document.getElementById('emailBody').value.trim();

  if (!to) { showToast(t('toastNoRecipient')); return; }

  const date = document.getElementById('meetingDate').value || 'meeting';
  const type = document.getElementById('meetingType').value || '';
  const pdfFilename = t('pdfFilename', type, date);

  showToast(t('toastGenerating'));

  const container = document.createElement('div');
  container.innerHTML = buildPdfHtml();
  container.style.position = 'absolute';
  container.style.left = '-9999px';
  document.body.appendChild(container);

  const opt = {
    margin: [10, 10, 10, 10],
    filename: pdfFilename,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
  };

  html2pdf().set(opt).from(container).outputPdf('blob').then(blob => {
    document.body.removeChild(container);
    const reader = new FileReader();
    reader.onloadend = () => {
      const base64 = reader.result.split(',')[1];
      fetch('http://localhost:3000/send-email', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ to, cc, subject, body, pdfBase64: base64, pdfFilename })
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          showToast(t('toastSent'));
          closeEmailModal();
        } else {
          showToast(t('toastSendFail', data.message));
        }
      })
      .catch(() => {
        showToast(t('toastNoServer'));
      });
    };
    reader.readAsDataURL(blob);
  });
}

function buildPdfHtml() {
  const date = document.getElementById('meetingDate').value || '';
  const type = document.getElementById('meetingType').value || '';
  const meetingTime = document.getElementById('meetingTime').value || '';
  const recorder = document.getElementById('recorder').value || '';
  const discussion = document.getElementById('discussion').value || '';

  const followupRows = [];
  document.querySelectorAll('#followupBody tr').forEach((tr, i) => {
    const cells = tr.querySelectorAll('td');
    const item = cells[1]?.querySelector('textarea')?.value || '';
    if (!item.trim()) return;
    const owner = cells[2]?.querySelector('input')?.value || '';
    const deadline = cells[3]?.querySelector('input')?.value || '';
    const statusEl = cells[4]?.querySelector('.status-badge');
    const status = statusEl?.textContent || '';
    const srcEl = cells[5]?.querySelector('.carryover-tag');
    const src = srcEl ? srcEl.textContent.trim() : 'â€”';
    const statusColor = statusEl?.classList.contains('status-done') ? '#2e7d32' : statusEl?.classList.contains('status-overdue') ? '#c62828' : statusEl?.classList.contains('status-continued') ? '#4527a0' : '#856404';
    followupRows.push(`
      <tr>
        <td style="text-align:center;background:#f0ead6;font-weight:700;color:#c9a84c;width:50px">${String(i+1).padStart(3,'0')}</td>
        <td style="padding:7px 10px">${item}</td>
        <td style="padding:7px 10px;text-align:center">${owner}</td>
        <td style="padding:7px 10px;text-align:center">${deadline}</td>
        <td style="padding:7px 10px;text-align:center"><span style="color:${statusColor};font-weight:600">${status}</span></td>
        <td style="padding:7px 10px;text-align:center;font-size:11px;color:#1565c0">${src}</td>
      </tr>`);
  });

  return `
    <div style="font-family: Georgia, 'Times New Roman', serif; line-height: 1.7; letter-spacing: 0.03em;color:#1a1a2e;max-width:900px;margin:0 auto;padding:24px">
      <div style="text-align:center;border-top:3px double #c9a84c;border-bottom:3px double #c9a84c;padding:16px 0;margin-bottom:24px">
        <div style="font-size:22px;font-weight:700;letter-spacing:6px">${t('pdfTitle')}</div>
        <div style="font-size:11px;color:#7a7267;letter-spacing:3px;margin-top:4px">${t('pdfSubtitle')}</div>
      </div>
      <table style="width:100%;border-collapse:collapse;border:1px solid #d4c9a8;margin-bottom:20px">
        <tr>
          <td style="background:#f0ead6;padding:9px 14px;font-weight:600;border:1px solid #d4c9a8;width:80px">${t('pdfMeetingType')}</td>
          <td style="padding:9px 14px;border:1px solid #d4c9a8">${type}</td>
          <td style="background:#f0ead6;padding:9px 14px;font-weight:600;border:1px solid #d4c9a8;width:80px">${t('pdfMeetingDate')}</td>
          <td style="padding:9px 14px;border:1px solid #d4c9a8">${date}</td>
        </tr>
        <tr>
          <td style="background:#f0ead6;padding:9px 14px;font-weight:600;border:1px solid #d4c9a8">${t('pdfMeetingTime')}</td>
          <td colspan="3" style="padding:9px 14px;border:1px solid #d4c9a8">${meetingTime}</td>
        </tr>
        <tr>
          <td style="background:#f0ead6;padding:9px 14px;font-weight:600;border:1px solid #d4c9a8">${t('pdfRecorder')}</td>
          <td colspan="3" style="padding:9px 14px;border:1px solid #d4c9a8">${recorder}</td>
        </tr>
      </table>
      <div style="border-left:4px solid #c9a84c;padding-left:10px;font-size:14px;font-weight:700;margin:20px 0 10px;letter-spacing:2px">${t('pdfDiscussion')}</div>
      <div style="border:1px solid #d4c9a8;padding:14px;min-height:60px;white-space:pre-wrap;font-size:13px;line-height:1.8">${discussion}</div>
      <div style="border-left:4px solid #c9a84c;padding-left:10px;font-size:14px;font-weight:700;margin:20px 0 10px;letter-spacing:2px">${t('pdfFollowup')}</div>
      <table style="width:100%;border-collapse:collapse;border:1px solid #d4c9a8;font-size:13px">
        <thead>
          <tr style="background:#f0ead6">
            <th style="padding:9px;border:1px solid #d4c9a8;width:50px">${t('pdfNo')}</th>
            <th style="padding:9px;border:1px solid #d4c9a8;text-align:left">${t('pdfItem')}</th>
            <th style="padding:9px;border:1px solid #d4c9a8;width:90px">${t('pdfOwner')}</th>
            <th style="padding:9px;border:1px solid #d4c9a8;width:100px">${t('pdfDeadline')}</th>
            <th style="padding:9px;border:1px solid #d4c9a8;width:80px">${t('pdfStatus')}</th>
            <th style="padding:9px;border:1px solid #d4c9a8;width:80px">${t('pdfSource')}</th>
          </tr>
        </thead>
        <tbody>${followupRows.join('') || `<tr><td colspan="6" style="text-align:center;padding:16px;color:#7a7267">${t('pdfNoFollowup')}</td></tr>`}</tbody>
      </table>
    </div>`;
}

function generatePDF() {
  const date = document.getElementById('meetingDate').value || 'meeting';
  const type = document.getElementById('meetingType').value || '';
  const filename = t('pdfFilename', type, date);

  const container = document.createElement('div');
  container.innerHTML = buildPdfHtml();
  container.style.position = 'absolute';
  container.style.left = '-9999px';
  document.body.appendChild(container);

  const opt = {
    margin: [10, 10, 10, 10],
    filename,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
  };

  html2pdf().set(opt).from(container).save().then(() => {
    document.body.removeChild(container);
  });
}

// â”€â”€ Contacts Manager â”€â”€
function manageContacts() {
  renderContactsManager();
  document.getElementById('contactsModal').classList.add('open');
}

function closeContactsModal() {
  document.getElementById('contactsModal').classList.remove('open');
  renderContactChips();
}

function renderContactsManager() {
  const body = document.getElementById('contactsManagerBody');
  const rows = contacts.map((c, i) => `
    <div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)">
      <div style="flex:1">
        <div style="font-weight:600;font-size:13px">${c.name}</div>
        <div style="font-size:11px;color:var(--muted)">${c.email}</div>
      </div>
      <button class="btn btn-danger" style="padding:4px 10px;font-size:11px" onclick="removeContact(${i})">${t('deleteBtn')}</button>
    </div>`).join('');

  body.innerHTML = `
    ${rows || '<div style="color:var(--muted);font-size:13px;padding:12px 0">å°šç„¡è¯çµ¡äºº</div>'}
    <div style="margin-top:16px;padding-top:14px;border-top:1px solid var(--border)">
      <div style="font-size:11px;font-weight:700;color:var(--gold);letter-spacing:1.5px;margin-bottom:8px">æ–°å¢è¯çµ¡äºº</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="newContactName" type="text" placeholder="${t('namePlaceholder')}" style="flex:1;min-width:100px;border:1px solid var(--border);border-radius:4px;padding:7px 10px;font-size:13px;outline:none">
        <input id="newContactEmail" type="email" placeholder="${t('emailPlaceholder')}" style="flex:2;min-width:160px;border:1px solid var(--border);border-radius:4px;padding:7px 10px;font-size:13px;outline:none">
        <button class="btn btn-primary" style="padding:7px 14px" onclick="addContact()">${t('addBtn')}</button>
      </div>
    </div>`;
}

function addContact() {
  const name = document.getElementById('newContactName').value.trim();
  const email = document.getElementById('newContactEmail').value.trim();
  if (!name || !email) { showToast(t('toastNoName')); return; }
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showToast(t('toastBadEmail')); return; }
  contacts.push({ name, email });
  localStorage.setItem('m31_contacts', JSON.stringify(contacts));
  renderContactsManager();
  showToast(t('toastContactAdded', name));
}

function removeContact(i) {
  contacts.splice(i, 1);
  localStorage.setItem('m31_contacts', JSON.stringify(contacts));
  renderContactsManager();
}

// â”€â”€ i18n Language Toggle â”€â”€
var currentLang = localStorage.getItem('m31_lang') || 'zh';

var ZH = {
  pageTitle: 'M31è²¡å‹™éƒ¨æœƒè­°è¨˜éŒ„ç³»çµ±', sidebarSub: 'æœƒè­°è¨˜éŒ„ç®¡ç†ç³»çµ±', langBtn: 'EN',
  newMeeting: 'æ–°å¢æœƒè­°è¨˜éŒ„', history: 'æ­·å²è¨˜éŒ„', searchPlaceholder: 'ğŸ” æœå°‹è¿½è¹¤äº‹é …æˆ–è² è²¬äººâ€¦',
  noHistory: 'å°šç„¡æ­·å²è¨˜éŒ„', noHistorySmall: 'å„²å­˜å¾Œå³é¡¯ç¤ºæ–¼æ­¤', noMatch: 'ç„¡ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„',
  all: 'å…¨éƒ¨', weekly: 'é€±æœƒ', monthly: 'æœˆæœƒ', project: 'å°ˆæ¡ˆ', system: 'ç³»çµ±', other: 'å…¶ä»–',
  docSubtitle: 'MEETING MINUTES Â· FINANCE DEPARTMENT',
  meetingType: 'æœƒè­°ä¸»é¡Œ', meetingDate: 'æœƒè­°æ—¥æœŸ', startTime: 'é–‹å§‹æ™‚é–“',
  duration: 'æœƒè­°é•·åº¦', meetingTime: 'æœƒè­°æ™‚é–“', recorder: 'è¨˜éŒ„äºº',
  selectPlaceholder: 'è«‹é¸æ“‡â€¦',
  d30: '30 åˆ†é˜', d60: '1 å°æ™‚', d90: '1.5 å°æ™‚', d120: '2 å°æ™‚', d150: '2.5 å°æ™‚', d180: '3 å°æ™‚',
  typeWeekly: 'éƒ¨é–€é€±æœƒ', typeMonthly: 'éƒ¨é–€æœˆæœƒ',
  followupFilter: 'è¿½è¹¤äº‹é …ç¯©é¸', crossFilter: 'ğŸ” è·¨æœƒè­°ç¯©é¸', closeCrossFilter: 'âœ• é—œé–‰ç¯©é¸',
  filterStatusLabel: 'ç¯©é¸ç‹€æ…‹ï¼š',
  inProgress: 'é€²è¡Œä¸­', done: 'å·²å®Œæˆ', overdue: 'é€¾æœŸ', continued: 'å·²å»¶çºŒ',
  discussion: 'æœƒè­°è¨è«–å…§å®¹', discussionPlaceholder: 'è«‹è¼¸å…¥æœ¬æ¬¡æœƒè­°è¨è«–äº‹é …ã€æ±ºè­°ã€å‚™è¨»â€¦',
  followupItems: 'è¿½è¹¤äº‹é …', no: 'ç·¨è™Ÿ', followupItem: 'è¿½è¹¤äº‹é …',
  owner: 'è² è²¬äºº', deadline: 'å®Œæˆæ—¥', status: 'ç‹€æ…‹', source: 'ä¾†æº',
  addItem: 'æ–°å¢è¿½è¹¤äº‹é …',
  save: 'ğŸ’¾ å„²å­˜è¨˜éŒ„', carryover: 'â†© å»¶çºŒè¿½è¹¤', sendEmail: 'ğŸ“§ å¯„é€è¨˜éŒ„', print: 'ğŸ–¨ åˆ—å°', deleteRecord: 'ğŸ—‘ åˆªé™¤æ­¤è¨˜éŒ„',
  emailModalTitle: 'ğŸ“§ å¯„é€æœƒè­°è¨˜éŒ„',
  contactsLabel: 'å›ºå®šè¯çµ¡äººï¼ˆé»é¸åŠ å…¥æ”¶ä»¶äººï¼‰', toEmailLabel: 'æ”¶ä»¶äºº Email', ccLabel: 'å‰¯æœ¬ CC',
  subjectLabel: 'ä¸»æ—¨', bodyLabel: 'ä¿¡ä»¶å…§æ–‡',
  emailHint: 'ğŸ’¡ é»æ“Šã€Œå¯„é€ã€å¾Œç³»çµ±æœƒè‡ªå‹•ç”¢ç”Ÿ PDF ä¸¦é€éæœ¬æ©Ÿä¼ºæœå™¨å¯„å‡ºã€‚è«‹å…ˆåœ¨çµ‚ç«¯æ©ŸåŸ·è¡Œ <strong>node server.js</strong>ã€‚',
  manageContacts: 'âš™ï¸ ç®¡ç†è¯çµ¡äºº', sendBtn: 'ğŸ“§ å¯„é€', cancel: 'å–æ¶ˆ',
  manageContactsTitle: 'âš™ï¸ ç®¡ç†å›ºå®šè¯çµ¡äºº',
  noContacts: 'å°šç„¡è¯çµ¡äººï¼Œé»ã€Œç®¡ç†è¯çµ¡äººã€æ–°å¢',
  addContactTitle: 'æ–°å¢è¯çµ¡äºº', namePlaceholder: 'å§“å', emailPlaceholder: 'Email',
  addBtn: 'æ–°å¢', deleteBtn: 'åˆªé™¤', close: 'é—œé–‰',
  carryoverTitle: 'â†© å»¶çºŒè¿½è¹¤äº‹é …', confirmCarryover: 'å¸¶å…¥é¸å–äº‹é …',
  noCarryover: 'å…¶ä»–æœƒè­°ä¸­æ²’æœ‰æœªå®Œæˆçš„è¿½è¹¤äº‹é …',
  carryoverOwner: 'è² è²¬äººï¼š', carryoverDeadline: 'å®Œæˆæ—¥ï¼š',
  toastSaved: 'âœ“ æœƒè­°è¨˜éŒ„å·²å„²å­˜', toastDeleted: 'è¨˜éŒ„å·²åˆªé™¤',
  toastNoRecipient: 'è«‹å¡«å¯«æ”¶ä»¶äºº Email', toastGenerating: 'â³ ç”¢ç”Ÿ PDF ä¸­ï¼Œè«‹ç¨å€™â€¦',
  toastSent: 'âœ… éƒµä»¶å·²æˆåŠŸå¯„å‡ºï¼', toastNoServer: 'âŒ ç„¡æ³•é€£ç·šä¼ºæœå™¨ï¼Œè«‹åœ¨çµ‚ç«¯æ©ŸåŸ·è¡Œ node server.js',
  toastNoName: 'è«‹å¡«å¯«å§“åèˆ‡ Email', toastBadEmail: 'Email æ ¼å¼ä¸æ­£ç¢º',
  confirmDelete: 'ç¢ºå®šåˆªé™¤æ­¤æœƒè­°è¨˜éŒ„ï¼Ÿ',
  validDate: 'è«‹å¡«å¯«æœƒè­°æ—¥æœŸ', validType: 'è«‹é¸æ“‡æœƒè­°ä¸»é¡Œ',
  filterLabels: { all: 'å…¨éƒ¨', pending: 'é€²è¡Œä¸­', done: 'å·²å®Œæˆ', overdue: 'é€¾æœŸ' },
  filterMeetingDate: 'æœƒè­°æ—¥æœŸ', filterMeetingType: 'æœƒè­°é¡å‹', filterItem: 'è¿½è¹¤äº‹é …',
  filterOwner: 'è² è²¬äºº', filterDeadline: 'å®Œæˆæ—¥', filterStatusCol: 'ç‹€æ…‹',
  pendingBadge: 'å¾…è¾¦', allDone: 'âœ“', filterEmpty: 'æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¿½è¹¤äº‹é …',
  pdfTitle: 'M31è²¡å‹™éƒ¨æœƒè­°è¨˜éŒ„', pdfSubtitle: 'MEETING MINUTES Â· FINANCE DEPARTMENT',
  pdfMeetingType: 'æœƒè­°ä¸»é¡Œ', pdfMeetingDate: 'æœƒè­°æ—¥æœŸ', pdfMeetingTime: 'æœƒè­°æ™‚é–“',
  pdfRecorder: 'è¨˜éŒ„äºº', pdfDiscussion: 'æœƒè­°è¨è«–å…§å®¹', pdfFollowup: 'è¿½è¹¤äº‹é …',
  pdfNo: 'ç·¨è™Ÿ', pdfItem: 'è¿½è¹¤äº‹é …', pdfOwner: 'è² è²¬äºº',
  pdfDeadline: 'å®Œæˆæ—¥', pdfStatus: 'ç‹€æ…‹', pdfSource: 'ä¾†æº', pdfNoFollowup: 'ç„¡è¿½è¹¤äº‹é …',
  filterCount: function(n, lbl) { return 'å…±æ‰¾åˆ° ' + n + ' ç­†ã€Œ' + lbl + 'ã€è¿½è¹¤äº‹é …'; },
  toastCarryover: function(n) { return 'âœ“ å·²å¸¶å…¥ ' + n + ' ç­†è¿½è¹¤äº‹é …'; },
  toastSendFail: function(msg) { return 'âŒ ç™¼ä¿¡å¤±æ•—ï¼š' + msg; },
  toastContactAdded: function(name) { return 'âœ“ å·²æ–°å¢ ' + name; },
  pdfFilename: function(type, date) { return 'M31è²¡å‹™éƒ¨_' + type + '_' + date + '.pdf'; },
  emailSubjectTemplate: function(type, date) { return 'ã€M31è²¡å‹™éƒ¨ã€‘' + type + ' æœƒè­°è¨˜éŒ„ ' + date; },
  emailFollowupLine: function(i, item, owner, deadline, status) { return '  ' + i + '. ' + item + 'ï¼ˆè² è²¬ï¼š' + owner + 'ï¼Œå®Œæˆæ—¥ï¼š' + deadline + 'ï¼Œç‹€æ…‹ï¼š' + status + 'ï¼‰'; },
  emailBodyTemplate: function(date, type, time, lines, recorder) {
    var nl = '\n';
    return 'å„ä½å¥½ï¼Œ' + nl + nl +
      'é™„ä»¶ç‚º ' + date + ' ' + type + 'ï¼ˆ' + time + 'ï¼‰æœƒè­°è¨˜éŒ„ï¼Œè«‹æŸ¥æ”¶ã€‚' + nl + nl +
      'ã€è¿½è¹¤äº‹é …æ‘˜è¦ã€‘' + nl +
      (lines.length ? lines.join(nl) : '  ç„¡è¿½è¹¤äº‹é …') + nl + nl +
      'å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹å›è¦†æ­¤éƒµä»¶ã€‚' + nl + nl +
      'M31è²¡å‹™éƒ¨' + nl +
      'è¨˜éŒ„äººï¼š' + recorder;
  },
};

var EN = {
  pageTitle: 'M31 Finance Meeting Records', sidebarSub: 'Meeting Records System', langBtn: 'ä¸­æ–‡',
  newMeeting: 'New Meeting', history: 'History', searchPlaceholder: 'ğŸ” Search action items or ownersâ€¦',
  noHistory: 'No records yet', noHistorySmall: 'Saved records appear here', noMatch: 'No matching records',
  all: 'All', weekly: 'Weekly', monthly: 'Monthly', project: 'Project', system: 'System', other: 'Other',
  docSubtitle: 'MEETING MINUTES Â· FINANCE DEPARTMENT',
  meetingType: 'Meeting Type', meetingDate: 'Date', startTime: 'Start Time',
  duration: 'Duration', meetingTime: 'Meeting Time', recorder: 'Recorded By',
  selectPlaceholder: 'Selectâ€¦',
  d30: '30 min', d60: '1 hr', d90: '1.5 hr', d120: '2 hr', d150: '2.5 hr', d180: '3 hr',
  typeWeekly: 'Dept. Weekly', typeMonthly: 'Dept. Monthly',
  followupFilter: 'Action Item Filter', crossFilter: 'ğŸ” Cross-Meeting Filter', closeCrossFilter: 'âœ• Close Filter',
  filterStatusLabel: 'Status: ',
  inProgress: 'In Progress', done: 'Done', overdue: 'Overdue', continued: 'Continued',
  discussion: 'Discussion Notes', discussionPlaceholder: 'Enter discussion points, decisions, remarksâ€¦',
  followupItems: 'Action Items', no: 'No.', followupItem: 'Action Item',
  owner: 'Owner', deadline: 'Due Date', status: 'Status', source: 'Source',
  addItem: 'Add Action Item',
  save: 'ğŸ’¾ Save', carryover: 'â†© Carry Over', sendEmail: 'ğŸ“§ Send Minutes', print: 'ğŸ–¨ Print', deleteRecord: 'ğŸ—‘ Delete',
  emailModalTitle: 'ğŸ“§ Send Meeting Minutes',
  contactsLabel: 'Saved Contacts (click to add)', toEmailLabel: 'To', ccLabel: 'CC',
  subjectLabel: 'Subject', bodyLabel: 'Message Body',
  emailHint: 'ğŸ’¡ Click "Send" to generate a PDF and send via local server. Make sure <strong>node server.js</strong> is running.',
  manageContacts: 'âš™ï¸ Manage Contacts', sendBtn: 'ğŸ“§ Send', cancel: 'Cancel',
  manageContactsTitle: 'âš™ï¸ Manage Contacts',
  noContacts: 'No contacts yet. Click "Manage Contacts" to add.',
  addContactTitle: 'Add Contact', namePlaceholder: 'Name', emailPlaceholder: 'Email',
  addBtn: 'Add', deleteBtn: 'Delete', close: 'Close',
  carryoverTitle: 'â†© Carry Over Action Items', confirmCarryover: 'Import Selected',
  noCarryover: 'No incomplete action items in other meetings',
  carryoverOwner: 'Owner: ', carryoverDeadline: 'Due: ',
  toastSaved: 'âœ“ Meeting saved', toastDeleted: 'Record deleted',
  toastNoRecipient: 'Please enter recipient email', toastGenerating: 'â³ Generating PDFâ€¦',
  toastSent: 'âœ… Email sent!', toastNoServer: 'âŒ Cannot connect. Run node server.js first.',
  toastNoName: 'Please enter name and email', toastBadEmail: 'Invalid email format',
  confirmDelete: 'Delete this meeting record?',
  validDate: 'Please enter meeting date', validType: 'Please select meeting type',
  filterLabels: { all: 'All', pending: 'In Progress', done: 'Done', overdue: 'Overdue' },
  filterMeetingDate: 'Date', filterMeetingType: 'Type', filterItem: 'Action Item',
  filterOwner: 'Owner', filterDeadline: 'Due Date', filterStatusCol: 'Status',
  pendingBadge: 'pending', allDone: 'âœ“', filterEmpty: 'No matching action items',
  pdfTitle: 'M31 Finance Dept. Meeting Minutes', pdfSubtitle: 'MEETING MINUTES Â· FINANCE DEPARTMENT',
  pdfMeetingType: 'Meeting Type', pdfMeetingDate: 'Date', pdfMeetingTime: 'Time',
  pdfRecorder: 'Recorded By', pdfDiscussion: 'Discussion Notes', pdfFollowup: 'Action Items',
  pdfNo: 'No.', pdfItem: 'Action Item', pdfOwner: 'Owner',
  pdfDeadline: 'Due Date', pdfStatus: 'Status', pdfSource: 'Source', pdfNoFollowup: 'No action items',
  filterCount: function(n, lbl) { return 'Found ' + n + ' "' + lbl + '" item(s)'; },
  toastCarryover: function(n) { return 'âœ“ ' + n + ' item(s) carried over'; },
  toastSendFail: function(msg) { return 'âŒ Send failed: ' + msg; },
  toastContactAdded: function(name) { return 'âœ“ Added ' + name; },
  pdfFilename: function(type, date) { return 'M31_Finance_' + type + '_' + date + '.pdf'; },
  emailSubjectTemplate: function(type, date) { return '[M31 Finance] ' + type + ' Meeting Minutes ' + date; },
  emailFollowupLine: function(i, item, owner, deadline, status) { return '  ' + i + '. ' + item + ' (Owner: ' + owner + ', Due: ' + deadline + ', Status: ' + status + ')'; },
  emailBodyTemplate: function(date, type, time, lines, recorder) {
    var nl = '\n';
    return 'Hi all,' + nl + nl +
      'Please find the meeting minutes for ' + type + ' on ' + date + ' (' + time + ') attached.' + nl + nl +
      '[Action Items Summary]' + nl +
      (lines.length ? lines.join(nl) : '  No action items') + nl + nl +
      'Please reply if you have any questions.' + nl + nl +
      'M31 Finance Dept.' + nl +
      'Recorded by: ' + recorder;
  },
};

function LD() { return currentLang === 'en' ? EN : ZH; }

function t(key) {
  var d = LD(), val = d[key];
  if (val === undefined) return key;
  if (typeof val === 'function') { return val.apply(null, Array.prototype.slice.call(arguments, 1)); }
  return val;
}

function toggleLang() {
  currentLang = currentLang === 'zh' ? 'en' : 'zh';
  localStorage.setItem('m31_lang', currentLang);
  applyLang();
}

function applyLang() {
  try {
    var d = LD();
    var $ = function(id) { return document.getElementById(id); };
    var setText = function(el, v) { if (el && v !== undefined) el.textContent = v; };
    var setHTML = function(el, v) { if (el && v !== undefined) el.innerHTML = v; };

    document.title = d.pageTitle;
    setText($('langToggleBtn'), d.langBtn);
    setText($('i18n-sidebar-sub'), d.sidebarSub);

    var zhT = document.querySelector('.doc-title');
    var enT = $('i18n-doc-title');
    if (zhT) zhT.style.display = currentLang === 'en' ? 'none' : '';
    if (enT) enT.style.display = currentLang === 'en' ? 'block' : 'none';
    setText($('i18n-doc-subtitle'), d.docSubtitle);

    setText(document.querySelector('.new-btn'), 'ï¼‹ ' + d.newMeeting);
    setText(document.querySelector('.sidebar-section'), d.history);
    var hs = $('historySearch'); if (hs) hs.placeholder = d.searchPlaceholder;
    var disc = $('discussion'); if (disc) disc.placeholder = d.discussionPlaceholder;

    var cellLabels = document.querySelectorAll('.cell-label');
    var labelKeys = ['meetingType','meetingDate','startTime','duration','meetingTime','recorder'];
    cellLabels.forEach(function(el, i) { if (d[labelKeys[i]]) el.textContent = d[labelKeys[i]]; });

    var typeSelect = $('meetingType');
    if (typeSelect) {
      var typeMap = {'':'', 'éƒ¨é–€é€±æœƒ':d.typeWeekly,'éƒ¨é–€æœˆæœƒ':d.typeMonthly,'å°ˆæ¡ˆ':d.project,'KPI':'KPI','ç³»çµ±':d.system,'å…¶ä»–':d.other};
      Array.from(typeSelect.options).forEach(function(o) {
        if (o.value === '') o.textContent = d.selectPlaceholder;
        else if (typeMap[o.value]) o.textContent = typeMap[o.value];
      });
    }

    var durSelect = $('meetingDuration');
    if (durSelect) {
      var durMap = {'30':d.d30,'60':d.d60,'90':d.d90,'120':d.d120,'150':d.d150,'180':d.d180};
      Array.from(durSelect.options).forEach(function(o) { if (durMap[o.value]) o.textContent = durMap[o.value]; });
    }

    var hfMap = {all:d.all,'é€±æœƒ':d.weekly,'æœˆæœƒ':d.monthly,'å°ˆæ¡ˆ':d.project,'KPI':'KPI','ç³»çµ±':d.system,'å…¶ä»–':d.other};
    document.querySelectorAll('.sf-btn').forEach(function(b) { var hf=b.getAttribute('data-hf'); if(hfMap[hf]!==undefined) b.textContent=hfMap[hf]; });

    var ftBtn = $('toggleFilterBtn'); if(ftBtn) ftBtn.textContent = filterOpen ? d.closeCrossFilter : d.crossFilter;

    var fsSpan = document.querySelector('.filter-controls span'); if(fsSpan) fsSpan.textContent = d.filterStatusLabel;
    var fbMap = {all:d.all,pending:d.inProgress,done:d.done,overdue:d.overdue};
    document.querySelectorAll('.filter-btn').forEach(function(b) { var s=b.getAttribute('data-status'); if(fbMap[s]!==undefined) b.textContent=fbMap[s]; });

    var st = document.querySelectorAll('.section-title');
    st.forEach(function(el) {
      if (el.style.margin === '0px' || el.style.margin === '0') setText(el, d.followupFilter);
      else if (el.getAttribute('data-i18n') === 'followupItems') setText(el, d.followupItems);
      else setText(el, d.discussion);
    });

    var ths = document.querySelectorAll('#followupTable thead th');
    var thKeys = ['no','followupItem','owner','deadline','status','source'];
    ths.forEach(function(th, i) { if (d[thKeys[i]]) th.textContent = d[thKeys[i]]; });

    setText(document.querySelector('.add-row-btn'), 'ï¼‹ ' + d.addItem);

    document.querySelectorAll('.btn-bar .btn').forEach(function(btn) {
      var oc = btn.getAttribute('onclick') || '';
      if (oc.indexOf('saveMeeting') !== -1) btn.textContent = d.save;
      else if (oc.indexOf('openCarryoverModal') !== -1) btn.textContent = d.carryover;
      else if (oc.indexOf('openEmailModal') !== -1) btn.textContent = d.sendEmail;
      else if (oc.indexOf('printPage') !== -1) btn.textContent = d.print;
      else if (oc.indexOf('deleteCurrentMeeting') !== -1) btn.textContent = d.deleteRecord;
    });

    setText(document.querySelector('#emailModal .modal-title'), d.emailModalTitle);
    var eLabels = document.querySelectorAll('#emailModal label');
    var eLabelKeys = ['contactsLabel','toEmailLabel','ccLabel','subjectLabel','bodyLabel'];
    eLabels.forEach(function(el, i) { if (eLabelKeys[i] && d[eLabelKeys[i]]) el.textContent = d[eLabelKeys[i]]; });
    var hint = document.querySelector('.email-hint'); if (hint) hint.innerHTML = d.emailHint;
    var eBtns = document.querySelectorAll('#emailModal .btn');
    eBtns.forEach(function(btn) {
      var oc = btn.getAttribute('onclick') || '';
      if (oc.indexOf('manageContacts') !== -1) btn.textContent = d.manageContacts;
      else if (oc.indexOf('sendEmail') !== -1) btn.textContent = d.sendBtn;
      else if (oc.indexOf('closeEmailModal') !== -1) btn.textContent = d.cancel;
    });

    setText(document.querySelector('#carryoverModal .modal-title'), d.carryoverTitle);
    document.querySelectorAll('#carryoverModal .btn').forEach(function(btn) {
      var oc = btn.getAttribute('onclick') || '';
      if (oc.indexOf('confirmCarryover') !== -1) btn.textContent = d.confirmCarryover;
      else if (oc.indexOf('closeCarryoverModal') !== -1) btn.textContent = d.cancel;
    });

    setText(document.querySelector('#contactsModal .modal-title'), d.manageContactsTitle);
    document.querySelectorAll('#contactsModal .btn').forEach(function(btn) {
      var oc = btn.getAttribute('onclick') || '';
      if (oc.indexOf('closeContactsModal') !== -1) btn.textContent = d.close;
    });

    document.querySelectorAll('.status-badge').forEach(function(b) {
      if (b.classList.contains('status-pending')) b.textContent = d.inProgress;
      else if (b.classList.contains('status-done')) b.textContent = d.done;
      else if (b.classList.contains('status-overdue')) b.textContent = d.overdue;
      else if (b.classList.contains('status-continued')) b.textContent = d.continued;
    });

    renderHistory();
    if (filterOpen) applyFilter(currentFilter);

  } catch(err) { console.error('applyLang error:', err); }
}

window.addEventListener('load', function() { if (currentLang === 'en') applyLang(); });


function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}
</script>
</body>
</html>
